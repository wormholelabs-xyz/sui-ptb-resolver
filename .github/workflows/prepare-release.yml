name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Commit SHA from main branch to release (leave empty for latest main)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  prepare-release:
    name: Prepare Release Branch
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate workflow trigger
        run: |
          echo "ðŸ”’ Security Check: Validating workflow trigger"
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "âŒ Only manual workflow dispatch allowed"
            exit 1
          fi

      - name: Determine Source Commit
        id: determine-commit
        run: |
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"

          if [[ -n "$COMMIT_SHA" ]]; then
            echo "ðŸŽ¯ Using specified commit: $COMMIT_SHA"
            # Verify the commit exists
            if ! git rev-parse --verify "$COMMIT_SHA" >/dev/null 2>&1; then
              echo "âŒ Commit '$COMMIT_SHA' not found"
              exit 1
            fi
            SOURCE_COMMIT="$COMMIT_SHA"
          else
            echo "ðŸ” Using latest commit from main"
            git fetch origin main
            SOURCE_COMMIT=$(git rev-parse origin/main)
          fi

          echo "source_commit=$SOURCE_COMMIT" >> $GITHUB_OUTPUT
          echo "âœ… Source commit: $SOURCE_COMMIT"

      - name: Create/Update Release Branch
        run: |
          SOURCE_COMMIT="${{ steps.determine-commit.outputs.source_commit }}"

          # Check if release branch exists
          if git ls-remote --heads origin release >/dev/null 2>&1; then
            echo "ðŸ”„ Release branch exists, updating it"
            git checkout release
            git reset --hard "$SOURCE_COMMIT"
          else
            echo "ðŸŒ¿ Creating new release branch"
            git checkout -b release "$SOURCE_COMMIT"
          fi

          # Force push to update release branch
          git push origin release --force
          echo "âœ… Release branch updated with commit $SOURCE_COMMIT"

      - name: Create Summary
        run: |
          SOURCE_COMMIT="${{ steps.determine-commit.outputs.source_commit }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ Release Branch Prepared

          ### Summary
          - **Source Commit**: \`$SOURCE_COMMIT\`
          - **Release Branch**: Updated/Created \`release\` branch
          - **Next Step**: The release workflow will automatically trigger

          ### What Happens Next
          1. ðŸš€ **Automatic**: Release workflow triggers on push to release branch
          2. ðŸ”’ **Manual**: 2 approvals required in production environment
          3. ðŸ“¦ **Release**: After approval, semantic-release creates version, changelog, and publishes to npm
          4. ðŸ“ **PR**: Changelog automatically merged back to main

          EOF
